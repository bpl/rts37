<!DOCTYPE HTML>
<html>
<head>
	<title>Alpha Site Pathfinding Tester</title>
	<script src="../engine/util.js"></script>
	<script src="tiletest.js"></script>
	<script type="text/javascript">

// Copyright Â© 2011 Aapo Laitinen <aapo.laitinen@iki.fi> unless otherwise noted

var map = [];

map.width = 128;
map.height = 64;

(function () {
	for (var i = 0; i < map.width * map.height; ++i) {
		map.push(1);
	}
	for (var i = 0; i < map.width; ++i) {
		map[i] = 3;
		map[map.length - 1 - i] = 3;
	}
	for (var i = 0; i < map.height; ++i) {
		map[i * map.width] = 3;
		map[(i + 1) * map.width - 1] = 3;
	}
})();

var startCoords = [2, 2];

var endCoords = [map.width - 3, map.height - 3];

map.coordsToIndex = function (x, y) {
	return y * this.width + x;
};

map.indexToCoords = function (idx) {
	return [idx % this.width, Math.floor(idx / this.width)];
};

var mapColors = ['#f00', '#ccc', '#00f', '#999'];
var tileSize = 7;

function drawTile(ctx, x, y, color) {
	ctx.fillStyle = color;
	ctx.fillRect(x * tileSize, y * tileSize, tileSize - 1, tileSize - 1);
}

function drawTiles(ctx, map, debug) {
	for (var y = 0; y < map.height; ++y) {
		for (var x = 0; x < map.width; ++x) {
			if (debug) {
				drawTile(ctx, x, y,
					(debug[y * map.width + x] ? '#fc0' : mapColors[map[y * map.width + x]])
				);
			} else {
				drawTile(ctx, x, y, mapColors[map[y * map.width + x]]);
			}
		}
	}
}

function drawObject(ctx, x, y, color) {
	ctx.fillStyle = color;
	ctx.beginPath();
	ctx.arc((x + 0.5) * tileSize, (y + 0.5) * tileSize, tileSize / 2 - 1, 0, Math.PI * 2, false);
	ctx.fill();
}

function drawPath(ctx, path, color) {
	ctx.strokeStyle = color;
	ctx.beginPath();
	var coords = map.indexToCoords(path[0]);
	ctx.moveTo((coords[0] + 0.5) * tileSize, (coords[1] + 0.5) * tileSize);
	for (var i = 1; i < path.length; ++i) {
		coords = map.indexToCoords(path[i]);
		ctx.lineTo((coords[0] + 0.5) * tileSize, (coords[1] + 0.5) * tileSize);
	}
	ctx.stroke();
}

function updateCanvas(ctx, debug) {
	ctx.clearRect(0, 0, 800, 600);
	drawTiles(ctx, map, debug);
	drawObject(ctx, startCoords[0], startCoords[1], '#f00');
	drawObject(ctx, endCoords[0], endCoords[1], '#0f0');
}

function handleNaiveAStarClick() {
}

function init() {
	var canvas = document.getElementById('screen');
	var ctx = canvas.getContext('2d');
	updateCanvas(ctx);
	ctx.lineWidth = 3;

	var lastX = -1;
	var lastY = -1;
	var setTo = 1;

	var brushSize = 0;

	function drawOnMap(cx, cy) {
		for (var x = cx - brushSize; x <= cx + brushSize; ++x) {
			for (var y = cy - brushSize; y <= cy + brushSize; ++y) {
				if (x > 0 && x < map.width - 1 && y > 0 && y < map.height - 1) {
					var idx = map.coordsToIndex(x, y);
					map[idx] = setTo;
					drawTile(ctx, x, y, mapColors[setTo]);
				}
			}
		}
	}

	canvas.addEventListener('mousedown', function (evt) {
		brushSize = document.getElementById('brush').selectedIndex;
		var x = Math.floor((evt.clientX - canvas.offsetLeft) / tileSize);
		var y = Math.floor((evt.clientY - canvas.offsetTop) / tileSize);
		if (x >= 0 && x < map.width && y >= 0 && y < map.height) {
			var idx = map.coordsToIndex(x, y);
			setTo = 3 - map[idx];
			drawOnMap(x, y);
			lastX = x;
			lastY = y;
		}
	}, false);

	canvas.addEventListener('mousemove', function (evt) {
		if (lastX < 0 || lastY < 0) {
			return;
		}
		var x = Math.floor((evt.clientX - canvas.offsetLeft) / tileSize);
		var y = Math.floor((evt.clientY - canvas.offsetTop) / tileSize);
		if (x >= 0 && x < map.width && y >= 0 && y < map.height && (x != lastX || y != lastY)) {
			var idx = map.coordsToIndex(x, y);
			drawOnMap(x, y);
			lastX = x;
			lastY = y;
		}
	}, false);

	canvas.addEventListener('mouseup', function (evt) {
		lastX = -1;
		lastY = -1;
	}, false);

	var elms = document.getElementsByTagName('button');
	for (var i = 0; i < elms.length; ++i) {
		elms[i].addEventListener('click', function () {
			var debug = (document.getElementById('debug').checked ? {} : null);
			var atStart = new Date();
			var path = Pathfinder[this.value](
				map,
				map.coordsToIndex(startCoords[0], startCoords[1]),
				map.coordsToIndex(endCoords[0], endCoords[1]),
				debug
			);
			var atEnd = new Date();
			if (document.getElementById('draw').checked) {
				updateCanvas(ctx, debug);
				if (path) {
					drawPath(ctx, path, '#000');
				}
			}
			document.getElementById('time').firstChild.nodeValue = 'Time : ' + (atEnd - atStart) + ' ms';
		}, false);
	}
}

window.addEventListener('load', init, false);

	</script>
</head>
<body>

<canvas id="screen" width="900" height="450"></canvas>

<div style="position : absolute; top : 20px; left : 920px;">

<p><button value="naiveAStar">Naive A*</button></p>

<p><button value="naiveAStar2">Naive A* 2</button></p>

<p><button value="naiveAStar3">Naive A* 3</button></p>

<p><button value="naiveAStar4">Naive A* 4</button></p>

<p><button value="naiveAStar5">Naive A* 5</button></p>

<p><button value="potentialField">Potential</button></p>

<p><button value="potentialField2">Potential 2</button></p>

<p><label><input type="checkbox" id="debug">Debug</label></p>

<p><label><input type="checkbox" id="draw" checked>Draw</label></p>

<p><select id="brush"><option value="0">1x1</option><option value="1">3x3</option><option value="2" selected>5x5</option></select></p>

<p id="time">Time: ? ms</p>

</div>

</body>
</html>